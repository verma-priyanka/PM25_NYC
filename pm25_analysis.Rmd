---
title: "Advanced Raster Final Project <br> Monitoring Trends in PM2.5 in NYC"
author: "Jordan Frey, Priyanka Verma"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
  theme: architect
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r, warning=FALSE, include=TRUE, message=FALSE}
library(sf)
library(tidyverse)
library(raster)
library(gstat)
library(lubridate)
library(plyr)
library(tmap)
library(rasterVis)
library(RColorBrewer)
```

## Data
The Data comes from the United States Environmental Protection Agency for a 10-year period from 2010-2020. Since we are only interested in the PM2.5 measure for the winter months, we add a filter to extract dates between December and March. 

```{r ,warning = FALSE, message = FALSE}
# Reads all csv files in this directory
data = list.files(path="data", pattern="*.csv", full.names=TRUE)
# Merges all csv files into a single dataframe for analysis
data_all = ldply(data, read_csv)
# replace spaces in column names with '_'
names(data_all) <- gsub(" ", "_", names(data_all))
# rename latitude & longitude columns
names(data_all)[names(data_all) == "SITE_LONGITUDE"] <- "x"
names(data_all)[names(data_all) == "SITE_LATITUDE"] <- "y"
# Convert to date format for filtering
data_all$Date <- data_all$Date %>% as.Date("%m/%d/%Y")
# extract year from Date as a new column for yearly interpolation
data_all[, "year"] <- format(data_all[,"Date"], "%Y")
# filter for winter months
df_winter <- data_all %>% 
  filter(strftime(data_all$Date, "%m") %in% c('12','01','02','03'))
```

## Spatial Conversion
The shapefile for the New York Core-based Statitical Area (CBSA) came from the U.S. Census Bureau and consist of counties in and around the New York City urban area. Counties in upstate New York, Long Island as well as surrounding states of New Jersey are also included. 
```{r, fig.align='center'}
# read in cbsa shapefile
nycbsa <- st_read("data/ny_cbsa.shp")

# convert sites to an sf object using projection from cbsa
epa_sites <- df_winter %>% 
  distinct(Site_ID, x, y) %>% 
  st_as_sf(coords = c("x", "y"), crs = st_crs(nycbsa))
```

## Explore Metropolitan Area & Air Pollution Monitoring Sites
The monitoring site that falls outside the metro area boundary and will be removed from the analysis
```{r, warning = FALSE, message = FALSE, fig.align='center'}
tmap_mode("view")

tm_shape(nycbsa, name = "NY Metropolitan Area", is.master = TRUE) + 
  tm_borders(col= "coral") +
  tm_layout(title = "New York Metro Area Air Pollution Monitoring Sites") +
  tm_shape(epa_sites, name = "EPA Air Monitoring Sites") +
  tm_dots(col="red")
```

## Rasterize
Rasterize the nycbsa shapefile for interpolation surface
```{r, fig.align='center', fig.height=4, fig.width=4}
# create a raster file with resolution of 0.01 for ny metro area
target <- raster(x = extent(nycbsa), crs = crs(nycbsa), res = 0.01)
# assign value of 1 to each pixel
values(target) <- 1
# crop raster surface to NY metro region
nycbsar <- nycbsa %>% rasterize(x = ., y = target, field = "GEOID")
# plot for visual check
par(mar = c(1, 0, 0, 4))
plot(nycbsar, axes = FALSE, box = FALSE, legend = FALSE)
```

## Interpolation
```{r, warning = FALSE, message = FALSE}
# assign year to winter months
# if jan-march, assign to previous year, else assign same year
df_winter$winter <- ifelse(format(df_winter$Date, "%m") == "12",
                           df_winter$year,as.numeric(df_winter$year)-1)
# create a list of all winter years
years <- unique(df_winter$winter)

# Interpolate for each winter season
# int_df.list: List of dataframes for each winter with monthly mean PM2.5
# invdist.list List of interpolated surfaces for each winter
int_df.list =list()
invdist.list = list()
for (each_year in years){
  # calculate mean for every month for a winter season
  int_df <- df_winter %>% 
  filter(winter == each_year) %>% 
  group_by(Site_ID, winter, x, y) %>%
  summarise_at(vars(Daily_Mean_PM2.5_Concentration),              
               list(PM_Mean = mean))
  # add dataframe to list
  int_df.list[[each_year]] = int_df
  
  # inverse distance interpolation for each year
  # create a gstat object
  invdist <- gstat(id = "PM_Mean",
                   formula = PM_Mean ~ 1,
                   locations = ~x + y,
                   data = int_df)
  # generate interpolated layer
  invdistr <- interpolate(object = nycbsar, model = invdist)
  # mask to metro area
  invdistrmsk <- mask(x = invdistr, mask = nycbsa)
  # add interpolated layer to list
  invdist.list[[each_year]] = invdistrmsk
}
```

# Plotting Interpolated Layer 
```{r, warning = FALSE, message = FALSE, fig.align='center'}
# create a stack for all interpolated layers for plotting
s <- stack(invdist.list)
# edit name for each layer
names(s) <-  gsub(x = names(s), pattern = "X", replacement = "Winter")
# set up theme for plot
mapTheme <- rasterTheme(region=brewer.pal(8,"Blues"), rev=TRUE)
# plot interpolated layers
levelplot(s, pretty = TRUE,  main="NY Metropolitan Area PM2.5 Mean",
          scales =list(tck = c(1,0)), par.settings=mapTheme)
```


```{r}
# # The legend is currently messed up
# # change plot to view below for interactive plots
# # plot interpolated layers
# tmap_mode("view")
# tm_shape(s) +
#   tm_raster(palette = "-magma", alpha = 0.5)+
#   tm_facets(as.layers = TRUE) +
#   tm_layout(title = "NY Metropolitan Area PM2.5 Mean", 
#             legend.outside.position = "left", legend.outside = TRUE)
```

